version: "3"
services:
  elasticsearch:
    image: registry.cn-hangzhou.aliyuncs.com/duc-cnzj/elasticsearch_with_ik:6.4.2
    container_name: elasticsearch
    environment:
      - cluster.name=docker-cluster
      - bootstrap.memory_lock=true
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
      - discovery.type=single-node
    volumes:
      - esdata:/usr/share/elasticsearch/data
    expose:
      - "9200"
    networks:
      - appnet
  frontend:
    image: registry.cn-hangzhou.aliyuncs.com/duc-cnzj/blog_frontend:local
    working_dir: /app
    networks:
      - appnet
    volumes:
      - ./configuration/default.conf:/etc/nginx/conf.d/default.conf
    ports:
      - ${FRONTEND_PORT:-8000}:80
  background:
    image: registry.cn-hangzhou.aliyuncs.com/duc-cnzj/blog_backgroung:local
    working_dir: /app
    networks:
      - appnet
    ports:
      - ${BACKGROUND_PORT:-8080}:80
  app:
    image: registry.cn-hangzhou.aliyuncs.com/duc-cnzj/blog_app:latest
    working_dir: /var/www/html
    ports:
      - 8001:80
    networks:
      - appnet
    volumes:
      - ./configuration/app.conf:/etc/nginx/sites-available/default
      - ./configuration/init.sh:/var/www/html/init.sh
      - ./configuration/wait-for-it.sh:/var/www/html/wait-for-it.sh
    environment:
      DB_HOST: ${DB_HOST}
      DB_DATABASE: ${DB_DATABASE}
      DB_PORT: ${DB_PORT}
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      BASH_NAMES: init.sh
    command: /bin/bash -c "envsubst < /var/www/html/.env.template > /var/www/html/.env && start-container"
  redis:
    image: redis:alpine
    networks:
      - appnet
    volumes:
      - redisdata:/data
    ports:
      - 16379:6379
  db:
    image: mysql:5.7
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD}
      MYSQL_DATABASE: ${DB_DATABASE}
      MYSQL_USER: ${DB_USERNAME}
      MYSQL_PASSWORD: ${DB_PASSWORD}
    networks:
      - appnet
    volumes:
      - dbdata:/var/lib/mysql
  echo-server:
    image: registry.cn-hangzhou.aliyuncs.com/duc-cnzj/laravel-echo-server
    ports:
     - "6001:6001"
    restart: always
    networks:
      - appnet
    volumes:
     - ./configuration/laravel-echo-server.json:/usr/src/app/laravel-echo-server.json
    depends_on:
      - app
      - redis
networks:
  appnet:
    driver: bridge
volumes:
  dbdata:
    driver: local
  esdata:
    driver: local
  redisdata:
    driver: local
